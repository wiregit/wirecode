package com.limegroup.gnutella.malware;

import java.io.File;

import org.limewire.logging.Log;
import org.limewire.logging.LogFactory;
import org.limewire.util.CommonUtils;

import com.limegroup.gnutella.util.LimeWireUtils;

class VirusUtils {
    
    private static final Log LOG = LogFactory.getLog(VirusUtils.class);

    private static class AVGTuple {
        File dir;
        int version;
    }
    
    static File getLicenseFile() {
        return new File("lib/avg/license");
    }

    static File getDatabaseDirectory() {
        if(LimeWireUtils.isTemporaryDirectoryInUse()) {
            return null;
        } else {
            return new File(CommonUtils.getUserSettingsDir(), "avg/database");
        }
    }

    static File getLatestFullDefinitionsDirectory() {
        return getLatestDefinitions(false).dir;
    }

    static int getLatestFullDefinitionsVersion() {
        return getLatestDefinitions(false).version;
    }

    static File getLatestDefinitionsDirectory() {
        return getLatestDefinitions(true).dir;
    }

    static int getLatestDefinitionsVersion() {
        return getLatestDefinitions(true).version;    
    }

    private static AVGTuple getLatestDefinitions(boolean includeIncremental) {
        File parent = getDatabaseDirectory();
        if(parent == null || !parent.exists() || !parent.isDirectory()) {
            return new AVGTuple();
        }
        AVGTuple tuple = new AVGTuple();
        for(File dir : parent.listFiles()) {
            if(!dir.isDirectory()) {
                continue;
            }
            String name = dir.getName();
            if(name.startsWith("avgsdk_vdb")) {
                name = name.replace("avgsdk_vdb", "");
            } else if(includeIncremental && name.startsWith("avgsdk_ivdb")) {
                name = name.replace("avgsdk_ivdb", "");
            } else {
                continue;
            }
            try {
                int version = Integer.parseInt(name);
                if(version > tuple.version) {
                    tuple.version = version;
                    tuple.dir = dir;
                }
            } catch(NumberFormatException skip) {
                LOG.debugf("Invalid name {0}", name);
            }
        }
        return tuple;
    }
}
